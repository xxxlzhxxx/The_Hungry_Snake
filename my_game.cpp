#include <iostream>
#include <cstdlib>
#include <ctime>
#include <vector>
#include <conio.h>
#include <graphics.h>
#include "windows.h"
using namespace std;

//计时工具：
int my_clock(double interval) {
    int my_time;
    my_time = clock() / (interval * 1000);
    return my_time;
}



//初始界面
void the_begining_surface() {
    cout << "------------------------------------------------ version 1.1.0 -------------------------------------------------------\n"
        "     ------------------------------------------------------------------------------\n"
        "    ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "  |||||||--||||||--///|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||==||||||=====||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "||||||||||||=====||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||||||    ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||                \n"
        " |||||||||||||===||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||            \n"
        "   |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "      |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "                                               |||||||||||||||||||||||||||||||||||| \n"
        "                                          |||||||||||||||||||||||||||||||||||||||  \n"
        "                                          |||||||||||||||||||||||||||||||||||||   \n"
        "                                        ||||||||||||||||||||||||||||||||||\n"
        "                                       |||||||||||||||||||||||||||||||||||\n"
        "                                        |||||||||||||||||||||||||||||||||||\n"
        "                                        |||||||||||||||||||||||||||||||||||\n"
        "                                         |||||||||||||||||||||||||||||||||||\n"
        "                                         |||||||||||||||||||||||||||||||||||\n"
        "                                          |||||||||||||||||||||||||||||||||||\n"
        "                                                                  \n"
        "                                   =======   |       |       |        |   |    |======\n"
        "                                   ||        | ||    |      |  |      |  |     |\n"
        "                                   =======   |  ||   |     |====|     ||       |======\n"
        "                                        ||   |   ||  |    |      |    |  |     |\n"
        "                                   =======   |     |||   |        |   |   |    |======\n"
        "   \n"
        "                      Press 'space' to get started while 'Esc' to quit...mind your language type!   \n"
        "----------------------------------------------------------------------------------------------------------------------";
}

//判断玩家是否要进入游戏
int if_start() {
    int ch;
    int the_start_signal = 0;
    while (the_start_signal == 0) {
        if (_kbhit) {
            ch = _getch();//使用_getch()函数获取按下的键值
            if (ch == 32) {
                the_start_signal = 1;
                break;
            }
            else if (ch == 27) {
                the_start_signal = -1;
                break;
            }
            else {
                system("cls");
                cout << "                                           Invalid input! Try again." << endl;
                cout << "                                              press Esc to quit!" << endl;
                cout << "                                             press space to start!" << endl;
                continue;
            }
        }
    }
    return the_start_signal;
}


//倒计时开始
void before_start() {
    int now = my_clock(1);
    int pres = now;
    do {
        if (my_clock(1) != pres) {
            pres++;
            if (my_clock(1) - now < 2) {
                SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_RED |
                    FOREGROUND_GREEN | FOREGROUND_BLUE);
                system("cls");
                cout << "\n"
                    "\n"
                    "\n"
                    "----------------------------------------------------------------------------------------------------------------------\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||             |||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||  ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||             |||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||  ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||             ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n";
            }
            else if ((((my_clock(1) - now) < 3)) && ((my_clock(1) - now) > 1)) {
                SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_BLUE);
                system("cls");
                cout << "\n"
                    "\n"
                    "\n"

                    "----------------------------------------------------------------------------------------------------------------------\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "                                                                                                                      \n"
                    "                                                                                                                      \n"
                    "                                                                                                                      \n"
                    "                                                |||||||||||||                                                         \n"
                    "                                                          |||                                                         \n"
                    "                                                          |||                                                         \n"
                    "                                                          |||                                                         \n"
                    "                                                          |||                                                         \n"
                    "                                                |||||||||||||                                                         \n"
                    "                                                |||                                                                   \n"
                    "                                                |||                                                                   \n"
                    "                                                |||                                                                   \n"
                    "                                                |||||||||||||                                                         \n"
                    "                                                                                                                      \n"
                    "                                                                                                                      \n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n";
            }
            else if ((((my_clock(1) - now) < 4)) && ((my_clock(1) - now) > 2)) {
                SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_RED |
                    FOREGROUND_GREEN);
                system("cls");
                cout << "\n"
                    "\n"
                    "\n"
                    "----------------------------------------------------------------------------------------------------------------------\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "||||||||||||||||||||||||||||||||||||||||||||||||||||||||  ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n"
                    "======================================================================================================================\n";
            }
            else continue;
        }
    } while (my_clock(1) - now < 4);
}

int choose_level() {
    system("cls");
    cout << "\n"
        "\n"
        "\n"
        "                                          Which level do you want to choose?\n"
        "                       You can choose from level 1--3, please press your number (i.e. press 1,2 or 3) \n";

    int level;
    int ch;
    while (1) {
        if (_kbhit()) {
            ch = _getch();
            if (ch == 49) { level = 1; break; }//当按下ESC时循环，ESC键的键值时27.
            else if (ch == 50) { level = 2; break; }
            else if (ch == 51) { level = 3; break; }
        }
    }
    return level;
}




int lose(int len) {
    SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_RED |
        FOREGROUND_GREEN | FOREGROUND_BLUE);
    system("cls");
    cout << "\n"
        "\n"
        "\n"
        "-----------------------------------------------------------------------------------------------------------------------\n"
        "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "||||||||||||||||----||||||||||||||||||-----------------||||||||||++++++++++++|||||||||||||+++++++++++++||||||||||||||||\n"
        "||||||||||||||||-  -||||||||||||||||||                |||||||||||            |||||||||||||            |||||||||||||||||\n"
        "||||||||||||||||-  -|||||||||||||||||| |||||||||||||| ||||||||||| |||||||||||||||||||||||| ||||||||||||||||||||||||||||\n"
        "||||||||||||||||-  -|||||||||||||||||| |||||||||||||| ||||||||||| |||||||||||||||||||||||| ||||||||||||||||||||||||||||\n"
        "||||||||||||||||-  -|||||||||||||||||| |||||||||||||| ||||||||||| |||||||||||||||||||||||| |-----------||||||||||||||||\n"
        "||||||||||||||||-  -|||||||||||||||||| |||||||||||||| |||||||||||            |||||||||||||            |||||||||||||||||\n"
        "||||||||||||||||-  -|||||||||||||||||| |||||||||||||| |||||||||||==========  ||||||||||||| ||||||||||||||||||||||||||||\n"
        "||||||||||||||||-  -|||||||||||||||||| |||||||||||||| |||||||||||||||||||||  ||||||||||||| ||||||||||||||||||||||||||||\n"
        "||||||||||||||||-  -|||||||||||||||||| |||||||||||||| |||||||||||||||||||||  ||||||||||||| ||||||||||||||||||||||||||||\n"
        "||||||||||||||||-  -------------|||||| -------------  |||||||||||||||||||||  ||||||||||||| |------------||||||||||||||||\n"
        "|||||||||||||||||              |||||||                |||||||||||            |||||||||||||             ||||||||||||||||\n"
        "||||||||||||||||----------------||||||----------------|||||||||||=============|||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||\n"
        "=================================" << " press 'Esc' to quit, press space ' ' to play again." << "==================================\n"
        "===========================================" << ">  your final lenghth is " << len << " ! ===============================================\n"
        "=======================================================================================================================\n";

    int end = 2;
    while (end == 2) {
        if (_kbhit()) {
            int ch = _getch();
            if (ch == 27) {
                end = 0;
                break;
            }
            else if (ch == 32) {
                end = 1;
                break;
            }
        }
    }
    return end;
}

enum Directions { up, down, leftt, rightt };

//判断当前方向与转向：
void judge_dir(Directions& a) {
    if (_kbhit()) {
        if (a == up) {
            int ch = _getch();
            if (ch == 97)  a = leftt;
            else if (ch == 100) a = rightt;
        }
        else if (a == down) {
            int ch = _getch();
            if (ch == 97)  a = rightt;
            else if (ch == 100) a = leftt;
        }
        else if (a == leftt) {
            int ch = _getch();
            if (ch == 97)  a = down;
            else if (ch == 100) a = up;
        }
        else if (a == rightt) {
            int ch = _getch();
            if (ch == 97)  a = up;
            else if (ch == 100) a = down;
        }
    }
}

int pos(int a, int b) {
    return 120 * (29 - b) + 2 * a + 2;
}


void screen(vector<int> S_X, vector<int> S_Y, int f_X, int& f_Y, int len) {
    //system("cls");    
    string str = "   |-----------------------------------------------------------------------|                                            \n"
        " |                                                                       |                                             \n"
        " |                                                                       |                                             \n"
        " |                                                                       |             WELOCOME TO THE GAME            \n"
        " |                                                                       |                                             \n"
        " |                                                                       |        remember to adapt your language to   \n"
        " |                                                                       |                    ENGLISH !                \n"
        " |                                                                       |                                             \n"
        " |                                                                       |                    TIPS                     \n"
        " |                                                                       |        -+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-      \n"
        " |                                                                       |          1. press 'A' to turn left.         \n"
        " |                                                                       |          2. press 'D' to turn right.        \n"
        " |                                                                       |          3. press 'Esc' to pause            \n"
        " |                                                                       |  DO NOT PRESS YOUR MOSE OR IT WILL GO DARK  \n"
        " |                                                                       |          The other keys are useless!!!      \n"
        " |                                                                       |        -+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-      \n"
        " |                                                                       |                   RULES                     \n"
        " |                                                                       |                                             \n"
        " |                                                                       |          1. Crash the wall, you die!        \n"
        " |                                                                       |          2. Eat yourself, you die!          \n"
        " |                                                                       |          3. Eat the fruit, you grow!        \n"
        " |                                                                       |                                             \n"
        " |                                                                       |            See how long you can grow!       \n"
        " |                                                                       |                                             \n"
        " |                                                                       |               BE THE LONGEST !!!            \n"
        " |                                                                       |                                             \n"
        " |                                                                       |                                             \n"
        " |                                                                       |                                             \n"
        " |                                                                       |                                             \n"
        " |-----------------------------------------------------------------------|                                            ";

    str[pos(f_X, f_Y)] = '>';
    str[pos(f_X, f_Y) - 1] = '<';
    for (int i = 0; i < len; i++) {
        str[pos(S_X[i], S_Y[i])] = 'o';
        str[pos(S_X[i], S_Y[i]) - 1] = 'o';
    }
    //cout<<S_X[0]<<","<<S_Y[0]<<" fruit "<<f_X<<","<<f_Y<<","<<len<<endl;
    cout << str;
}

int in_the_game(int level) {
    //判断选择难度
    double your_level;
    if (level == 1) your_level = 0.5;
    else if (level == 2) your_level = 0.3;
    else if (level == 3) your_level = 0.15;

    //设置蛇的初始状态：   出生在正中间， 整个棋盘为20*20
    int life = 1;
    Directions snake_dir;
    Directions& a = snake_dir;
    int x = 18, y = 14;
    snake_dir = up;
    vector<int> S_X;
    vector<int> S_Y;
    S_X.push_back(x); S_Y.push_back(y); S_X.push_back(x); S_Y.push_back(y - 1); S_X.push_back(x); S_Y.push_back(y - 2);
    int this_time = my_clock(your_level);
    int f_X, f_Y, f_state = 0;
    int* s_X = &S_X[0];
    int* s_Y = &S_Y[0];
    int& f_x = f_X;
    int& f_y = f_Y;
    int lengthh;
    srand(time(NULL));   //这是为了保证每次生成的种子都不一样
    do {
        judge_dir(a);
        //回合
        if (my_clock(your_level) != this_time) {      //这里应该是一回合内干的事：

            this_time++;
            //生成果实：
            if (f_state == 0) {
                int cannot;
                do {
                    f_X = (rand() % (35) + 1);
                    f_Y = (rand() % (28) + 1);
                    cannot = 0;
                    for (int i = 0; i < S_X.size(); i++) {
                        if ((f_X == S_X[i]) && (f_Y == S_Y[i])) cannot = 1;
                    }
                } while (cannot == 1);
                f_state = 1;
            }
            //移动：
            int len = S_X.size();
            int temp_X = S_X[len - 1];
            int temp_Y = S_Y[len - 1];
            for (int i = len - 1; i > 0; i--) {
                S_X[i] = S_X[i - 1];
                S_Y[i] = S_Y[i - 1];
            }
            if (snake_dir == up) S_Y[0] ++;
            else if (snake_dir == down) S_Y[0]--;
            else if (snake_dir == leftt) S_X[0]--;
            else if (snake_dir == rightt) S_X[0]++;

            //看是否吃果子
            if ((S_X[0] == f_X) && (S_Y[0] == f_Y)) {
                S_X.push_back(temp_X);
                S_Y.push_back(temp_Y);
                f_state = 0;
                len++;
            }
            screen(S_X, S_Y, f_x, f_y, len);
        }

        //计算生命：
        if ((S_X[0] > 35) || (S_X[0] < 1) || (S_Y[0] > 28) || (S_Y[0] < 1)) life = 0;
        else {
            int iscrash = 0;
            for (int i = 1; i < S_X.size(); i++) {
                if ((S_X[0] == S_X[i]) && (S_Y[0] == S_Y[i])) iscrash = 1;
            }
            if (iscrash == 1) life = 0;
        }
    } while (life > 0);
    return S_X.size();
}



class my_g {
protected:
    
public:
    void mygame() {
        int the_start_signal;
        int the_quit_signal = 1;
        the_start_signal = if_start();
        if (the_start_signal == -1) system("cls");
        //  第二步：开始游戏
        else if (the_start_signal == 1) {
            while (the_quit_signal == 1) {
                int level = choose_level();
                before_start();  //开始前倒计时
                system("cls");
                int len = in_the_game(level);
                the_quit_signal = lose(len);
            }
        }
    }
};

int main() {
    SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_RED | FOREGROUND_GREEN);
    the_begining_surface();

    initgraph(1080, 680);
    setbkcolor(WHITE);
    cleardevice();
    settextcolor(RED);
    settextstyle(50, 0, L"微软雅黑");
    outtextxy(460, 480, L"贪 吃 蛇");
    IMAGE begining;
    loadimage(&begining, "./")



    //  第一步：启动游戏
    my_g game;
    game.mygame();
    return 0;
}
